---
title: MQ性能优化-网卡
tags:
---


top

```
Cpu0  :  7.2%us,  4.1%sy,  0.0%ni, 78.8%id,  8.2%wa,  0.0%hi,  1.7%si,  0.0%st
Cpu1  :  1.3%us,  0.3%sy,  0.0%ni, 97.3%id,  1.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu2  :  0.7%us,  0.0%sy,  0.0%ni, 99.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu3  :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu4  :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu5  :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu6  :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu7  :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu8  :  2.4%us,  0.7%sy,  0.0%ni, 92.3%id,  4.7%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu9  :  2.3%us,  0.3%sy,  0.0%ni, 97.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu10 :  1.7%us,  0.7%sy,  0.0%ni, 97.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu11 :  1.0%us,  0.3%sy,  0.0%ni, 98.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu12 :  0.7%us,  0.3%sy,  0.0%ni, 99.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu13 :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu14 :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu15 :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu16 :  1.7%us,  1.0%sy,  0.0%ni, 96.3%id,  1.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu17 :  0.3%us,  0.3%sy,  0.0%ni, 99.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu18 :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu19 :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu20 :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu21 :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu22 :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu23 :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu24 :  1.3%us,  0.3%sy,  0.0%ni, 98.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu25 :  1.3%us,  0.3%sy,  0.0%ni, 98.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu26 :  1.0%us,  0.0%sy,  0.0%ni, 99.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu27 :  0.7%us,  0.3%sy,  0.0%ni, 99.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu28 :  0.7%us,  0.0%sy,  0.0%ni, 99.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu29 :  0.7%us,  0.0%sy,  0.0%ni, 99.3%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu30 :  0.0%us,  0.0%sy,  0.0%ni,100.0%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
Cpu31 :  0.3%us,  0.0%sy,  0.0%ni, 99.7%id,  0.0%wa,  0.0%hi,  0.0%si,  0.0%st
```

mpstat是MultiProcessor Statistics的缩写，是实时系统监控工具。其报告与CPU的一些统计信息，这些信息存放在/proc/stat文件中。在多CPUs系统里，其不 但能查看所有CPU的平均状况信息，而且能够查看特定CPU的信息

mpstat -P ALL 2 3
```
10:43:03 AM  CPU    %usr   %nice    %sys %iowait    %irq   %soft  %steal  %guest   %idle
10:43:08 AM  all    1.00    0.00    0.28    0.24    0.00    0.04    0.00    0.00   98.43
10:43:08 AM    0    6.39    0.00    3.51    0.82    0.00    1.44    0.00    0.00   87.84
10:43:08 AM    1    0.80    0.00    0.40    0.00    0.00    0.00    0.00    0.00   98.79
10:43:08 AM    2    1.00    0.00    0.20    0.00    0.00    0.00    0.00    0.00   98.80
10:43:08 AM    3    0.60    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.20
10:43:08 AM    4    0.40    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.40
10:43:08 AM    5    0.20    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.80
10:43:08 AM    6    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
10:43:08 AM    7    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
10:43:08 AM    8    3.01    0.00    0.40    5.42    0.00    0.00    0.00    0.00   91.16
10:43:08 AM    9    2.21    0.00    0.60    0.00    0.00    0.00    0.00    0.00   97.18
10:43:08 AM   10    2.00    0.00    0.60    0.00    0.00    0.00    0.00    0.00   97.40
10:43:08 AM   11    1.20    0.00    0.20    0.00    0.00    0.00    0.00    0.00   98.59
10:43:08 AM   12    1.00    0.00    0.20    0.00    0.00    0.00    0.00    0.00   98.80
10:43:08 AM   13    0.40    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.40
10:43:08 AM   14    0.60    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.40
10:43:08 AM   15    0.60    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.40
10:43:08 AM   16    1.41    0.00    0.40    0.00    0.00    0.00    0.00    0.00   98.19
10:43:08 AM   17    0.60    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.20
10:43:08 AM   18    0.40    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.60
10:43:08 AM   19    0.20    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.80
10:43:08 AM   20    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
10:43:08 AM   21    0.40    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.40
10:43:08 AM   22    0.00    0.00    0.00    0.00    0.00    0.00    0.00    0.00  100.00
10:43:08 AM   23    0.20    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.80
10:43:08 AM   24    1.81    0.00    0.20    1.41    0.00    0.00    0.00    0.00   96.58
10:43:08 AM   25    1.81    0.00    0.20    0.00    0.00    0.00    0.00    0.00   97.99
10:43:08 AM   26    0.80    0.00    0.20    0.00    0.00    0.00    0.00    0.00   98.99
10:43:08 AM   27    1.00    0.00    0.20    0.00    0.00    0.00    0.00    0.00   98.80
10:43:08 AM   28    0.60    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.20
10:43:08 AM   29    0.40    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.60
10:43:08 AM   30    0.60    0.00    0.20    0.00    0.00    0.00    0.00    0.00   99.20
10:43:08 AM   31    0.60    0.00    0.00    0.00    0.00    0.00    0.00    0.00   99.40
```

watch -d -n 1 'cat /proc/softirqs'

```
                CPU0	   CPU1       CPU2	 CPU3       CPU4       CPU5	  CPU6       CPU7	CPU8	   CPU9       CPU10	 CPU11      CPU12      CPU13	  CPU14      CPU15	CPU16
CPU17	   CPU18      CPU19	 CPU20      CPU21      CPU22	  CPU23      CPU24	CPU25	   CPU26      CPU27	 CPU28      CPU29      CPU30	  CPU31
      HI:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0	   0
   0          0          0          0          0          0          0          0          0          0          0          0          0          0          0
   TIMER: 1096611685 4276935973 2601458618 1636429535 1057773282  673632088  446759193  350514268  240016884 3828632390 2986983590 2277111968 1673243373 1208033516  861475149  643216754  612900957 179874
8225 1558567087 1013375998  587691737  385909681  307891161  272910745 2484332709 2753327730 2023821070 1656685300 1079014458  788598089  597748780  491158119
  NET_TX:   42012761     301844     236552     179405     119138      74546	 33230      12006    1564708    1203280     849074     605668     394757     270121     163983     106647     618646	  1
5998	  11301       7837	 4403       2718       1604	  1068     431131     311997     188338     115281	60806	   35463      18322	 10011
  NET_RX: 1462165290     315565     215857     153409     146441     125144     166946      75981     464037     338187     203460     100895     169796     197504     341819     271772     238268     20
5007     156910     130771     157831	   61921     161441	 50764     356057     354041     216805     111839     248562     239669     387261     292488
   BLOCK:  438213451          0          0          0          0          0          0          0 1242929249          0          0          0          0          0          0          0	   0
   0          0          0          0          0          0          0          0          0          0          0          0          0          0          0
BLOCK_IOPOLL:          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0
       0          0          0          0          0          0          0          0          0          0          0          0          0          0          0
 TASKLET:  439447945	   4982       1347        415        148         72         29         18	9966	   3809       1434        791        426        254        153        120   38179977
  70         57         25         23         15          7          4        308        206        152        109         74         68         44         38
   SCHED: 3977315914 1497275776 1229362768 1029426807  772156426  518225075  338316698  250774833 1469566195 1380353962 1232797470 1100410681  971350082  809736540  624433652  473925167 2279441377 113648
0817 1020330559  736868845  462257238  317837998  256162100  228762618 1211624949 1309342912 1107708439 1022806653  782956422  607825747  470355594  383220845
 HRTIMER:  134710777   94622398   48181668   31261665   19226681   12061639    7336497    5062435   70145527   66963017   54480092   42555999   30220659   21314458   14533110   10578411   97763019   2165
2445   17772731   12242175    7928778    5905585    4707419    3957122   40691403   39901584   30151560   24205599   17255498   12592557    9363507    7929636
     RCU: 1147746871   46409273 2619497406 1640459513 1059354006  674634877  447710971  351419663  215034165 3806126004 2965625217 2260381958 1661445189 1200216833  857092150  640884145  504832834 180849
6874 1585971351 1023059204  591503395  387120386  308338131  273181061 2458992342 2750337244 2048619170 1655088856 1072488330  782771309  593831281  488759496

```

```
$cat /proc/interrupts  | grep eth
        CPU0       CPU1       CPU2       CPU3       CPU4       CPU5       CPU6       CPU7       CPU8       CPU9       CPU10      CPU11      CPU12      CPU13      CPU14      CPU15      CPU16      CPU1
7      CPU18      CPU19      CPU20      CPU21      CPU22      CPU23      CPU24      CPU25      CPU26      CPU27      CPU28      CPU29      CPU30      CPU31
 109: 1333106007          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth0-0
 110: 2590214692          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth0-1
 111: 2310580523          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth0-2
 112: 2707898137          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth0-3
 113:  808583223          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0          0  IR-PCI-MSI-edge      eth0-4
```

```
$sudo cat /proc/irq/111/smp_affinity_list
0-7,16-23
```

```
$ethtool -c eth0
Coalesce parameters for eth0:
Adaptive RX: off  TX: off
stats-block-usecs: 0
sample-interval: 0
pkt-rate-low: 0
pkt-rate-high: 0

rx-usecs: 20
rx-frames: 5
rx-usecs-irq: 0
rx-frames-irq: 5

tx-usecs: 72
tx-frames: 53
tx-usecs-irq: 0
tx-frames-irq: 5

rx-usecs-low: 0
rx-frame-low: 0
tx-usecs-low: 0
tx-frame-low: 0

rx-usecs-high: 0
rx-frame-high: 0
tx-usecs-high: 0
tx-frame-high: 0
```

查看网卡队列

```
ls -l /sys/class/net/eth0/queues/
drwxr-xr-x 2 root root 0 Jul 26 11:33 rx-0
drwxr-xr-x 2 root root 0 Jul 26 11:33 rx-1
drwxr-xr-x 2 root root 0 Jul 26 11:33 rx-2
drwxr-xr-x 2 root root 0 Jul 26 11:33 rx-3
drwxr-xr-x 2 root root 0 Jul 26 11:33 tx-0
```